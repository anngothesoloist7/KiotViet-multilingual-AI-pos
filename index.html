<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knote Voice POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* ... Giá»¯ nguyÃªn CSS cá»§a báº¡n ... */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-ring { 
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } 
        }
        .mic-active { 
            background-color: #ef4444 !important; 
            color: white !important; 
            animation: pulse-ring 2s infinite; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-200 h-screen flex justify-center items-center overflow-hidden font-sans select-none">

    <div class="w-full max-w-md h-[850px] bg-white sm:rounded-[3rem] shadow-2xl overflow-hidden flex flex-col relative border-[8px] border-gray-100">
        <div id="screen-pos" class="flex flex-col h-full fade-in">
             <div class="px-8 pt-10 pb-4 bg-white z-10">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">New Order</h1>
                        <p id="statusText" class="text-gray-500 font-medium mt-1">Tap mic to start listening...</p>
                    </div>
                    <button onclick="openMenuScreen()" class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 shadow-sm hover:bg-gray-200 transition-colors">
                        <i class="ph-bold ph-list text-xl"></i>
                    </button>
                </div>
                </div>
            
            <div id="cart-container" class="flex-1 overflow-y-auto px-6 py-2 space-y-3 bg-gray-50 no-scrollbar">
                <div id="empty-state" class="flex flex-col items-center justify-center h-64 text-gray-400">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i class="ph-fill ph-basket text-4xl text-gray-300"></i>
                    </div>
                    <p class="font-medium">Cart is empty</p>
                </div>
            </div>

            <div class="bg-white border-t border-gray-100 p-6 pb-8 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-20">
                <div class="flex justify-between items-end mb-5 px-2">
                    <span class="text-gray-400 font-bold text-sm uppercase tracking-wider">Total</span>
                    <div class="flex items-start">
                        <span class="text-lg font-bold text-gray-900 mt-1 mr-1">$</span>
                        <span id="totalPrice" class="text-4xl font-extrabold text-gray-900 tracking-tight">0</span>
                    </div>
                </div>

                <div class="flex gap-4 items-center">
                    <button id="micBtn" onclick="toggleVoice()" class="w-20 h-20 rounded-3xl bg-gray-100 text-gray-800 flex items-center justify-center transition-all active:scale-95 shadow-sm hover:bg-gray-200">
                        <i id="micIcon" class="ph-fill ph-microphone text-3xl"></i>
                    </button>

                    <button onclick="goToPayment()" class="flex-1 h-20 bg-blue-600 text-white rounded-3xl font-bold text-xl shadow-lg shadow-blue-200 active:scale-95 transition-transform flex items-center justify-center gap-3 hover:bg-blue-700">
                        Checkout
                        <i class="ph-bold ph-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="screen-payment" class="hidden flex-col h-full bg-gray-50 p-8 pt-12 fade-in"><h2 class="text-3xl font-bold text-gray-900 mb-2">Payment</h2><p class="text-gray-500 mb-8 font-medium">Choose a payment method</p><div class="space-y-4 flex-1"><button onclick="goToQR('MoMo')" class="w-full bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex items-center justify-between group hover:border-pink-500 hover:shadow-md transition-all active:scale-95"><div class="flex items-center gap-4"><div class="w-14 h-14 rounded-2xl bg-pink-50 text-pink-600 flex items-center justify-center text-3xl"><i class="ph-fill ph-wallet"></i></div><div class="text-left"><span class="block text-xl font-bold text-gray-900">MoMo</span><span class="text-gray-400 text-sm font-medium">E-Wallet</span></div></div><i class="ph-bold ph-caret-right text-gray-300 group-hover:text-pink-500"></i></button><button onclick="goToQR('ZaloPay')" class="w-full bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex items-center justify-between group hover:border-blue-500 hover:shadow-md transition-all active:scale-95"><div class="flex items-center gap-4"><div class="w-14 h-14 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center text-3xl"><i class="ph-fill ph-credit-card"></i></div><div class="text-left"><span class="block text-xl font-bold text-gray-900">ZaloPay</span><span class="text-gray-400 text-sm font-medium">E-Wallet</span></div></div><i class="ph-bold ph-caret-right text-gray-300 group-hover:text-blue-500"></i></button><button onclick="goToQR('Cash')" class="w-full bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex items-center justify-between group hover:border-green-500 hover:shadow-md transition-all active:scale-95"><div class="flex items-center gap-4"><div class="w-14 h-14 rounded-2xl bg-green-50 text-green-600 flex items-center justify-center text-3xl"><i class="ph-fill ph-money"></i></div><div class="text-left"><span class="block text-xl font-bold text-gray-900">Cash</span><span class="text-gray-400 text-sm font-medium">Counter</span></div></div><i class="ph-bold ph-caret-right text-gray-300 group-hover:text-green-500"></i></button></div><button onclick="showScreen('screen-pos')" class="w-full py-6 text-gray-500 font-bold hover:text-gray-800 transition-colors">Back to Order</button></div>
        <div id="screen-qr" class="hidden flex-col h-full bg-white p-8 justify-center items-center text-center fade-in"><h2 class="text-2xl font-bold text-gray-900 mb-2">Scan to Pay</h2><p id="payment-method-label" class="text-gray-500 mb-10 font-medium">Waiting for payment...</p><div class="p-4 border-2 border-gray-100 rounded-3xl shadow-xl mb-10"><img src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=KnotePOSDemo" alt="QR Code" class="rounded-xl opacity-90"></div><div class="flex items-center gap-2 text-blue-600 font-bold mb-16 animate-pulse"><i class="ph-bold ph-spinner animate-spin text-xl"></i><span>Processing...</span></div><button onclick="cancelPayment()" class="w-full bg-gray-100 text-gray-600 py-4 rounded-2xl font-bold hover:bg-gray-200 transition-colors">Cancel</button></div>
        <div id="screen-success" class="hidden flex-col h-full bg-green-500 p-8 justify-center items-center text-center text-white fade-in"><div class="w-32 h-32 bg-white rounded-full flex items-center justify-center text-green-500 mb-8 shadow-2xl animate-[bounce_1s_infinite]"><i class="ph-bold ph-check text-6xl"></i></div><h1 class="text-4xl font-extrabold mb-4">Order Sent!</h1><p class="text-green-100 text-lg mb-12 font-medium">Kitchen has received ticket #088.</p><button onclick="resetApp()" class="w-full bg-white text-green-600 py-5 rounded-2xl font-bold text-xl shadow-lg hover:scale-105 transition-transform">New Order</button></div>
        <div id="screen-menu" class="hidden flex-col h-full bg-gray-50 fade-in"><div class="px-8 pt-10 pb-4 bg-white"><div class="flex justify-between items-center mb-4"><h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Menu</h1><button onclick="showScreen('screen-pos')" class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center"><i class="ph-bold ph-x text-xl text-gray-600"></i></button></div><p class="text-gray-500 font-medium">Add items with prices for quick ordering</p></div><form id="add-menu-form" class="px-8 py-4 bg-white border-b" onsubmit="addMenuItem(event)"><div class="flex gap-3"><input type="text" id="new-item-name" placeholder="Item name" required class="flex-1 px-4 py-3 bg-gray-100 rounded-xl text-gray-800 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500"><input type="number" id="new-item-price" placeholder="Price" required min="0" class="w-28 px-4 py-3 bg-gray-100 rounded-xl text-gray-800 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500"><button type="submit" class="px-5 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 active:scale-95 transition-all"><i class="ph-bold ph-plus"></i></button></div></form><div id="menu-list" class="flex-1 overflow-y-auto px-6 py-4 space-y-3 no-scrollbar"><div id="menu-empty" class="flex flex-col items-center justify-center h-48 text-gray-400"><i class="ph-fill ph-fork-knife text-5xl text-gray-300 mb-3"></i><p class="font-medium">No menu items yet</p></div></div><div class="bg-white border-t p-6"><button onclick="showScreen('screen-pos')" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-bold text-lg active:scale-95 transition-transform">Done</button></div></div>

    </div>

    <script>
        // 1. STATE & VARIABLES
        let currentOrder = [];
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        let qrTimer = null;

        // UI References
        const statusText = document.getElementById('statusText');
        const micBtn = document.getElementById('micBtn');
        const micIcon = document.getElementById('micIcon');
        const cartContainer = document.getElementById('cart-container');
        const emptyState = document.getElementById('empty-state');
        const totalPriceEl = document.getElementById('totalPrice');

        // 2. NAVIGATION LOGIC
        function showScreen(screenId) {
            ['screen-pos', 'screen-payment', 'screen-qr', 'screen-success', 'screen-menu'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        // MENU MANAGEMENT
        let menuItems = [];

        async function loadMenu() {
            try {
                const res = await fetch('/menu');
                const data = await res.json();
                menuItems = data.items || [];
                renderMenuList();
            } catch (e) {
                console.error('Failed to load menu:', e);
            }
        }

        function renderMenuList() {
            const list = document.getElementById('menu-list');
            const empty = document.getElementById('menu-empty');
            
            if (menuItems.length === 0) {
                list.innerHTML = '';
                list.appendChild(empty);
                empty.style.display = 'flex';
                return;
            }
            
            empty.style.display = 'none';
            list.innerHTML = menuItems.map(item => `
                <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex items-center justify-between fade-in">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-orange-50 text-orange-500 flex items-center justify-center text-xl">
                            ${guessIcon(item.name)}
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800">${item.name}</h3>
                            <p class="text-gray-500 text-sm">${item.price.toLocaleString()}</p>
                        </div>
                    </div>
                    <button onclick="deleteMenuItem('${item.id}')" class="p-2 text-gray-300 hover:text-red-500 transition-colors">
                        <i class="ph-bold ph-trash text-xl"></i>
                    </button>
                </div>
            `).join('');
        }

        async function addMenuItem(e) {
            e.preventDefault();
            const nameInput = document.getElementById('new-item-name');
            const priceInput = document.getElementById('new-item-price');
            
            const price = parseInt(priceInput.value, 10);
            if (isNaN(price) || price < 0) {
                alert('Please enter a valid price');
                return;
            }
            
            try {
                const res = await fetch('/menu', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: nameInput.value.trim(), price: price })
                });
                
                if (res.ok) {
                    nameInput.value = '';
                    priceInput.value = '';
                    await loadMenu();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to add item');
                }
            } catch (e) {
                console.error('Failed to add menu item:', e);
            }
        }

        async function deleteMenuItem(id) {
            try {
                await fetch(`/menu/${id}`, { method: 'DELETE' });
                await loadMenu();
            } catch (e) {
                console.error('Failed to delete:', e);
            }
        }

        function openMenuScreen() {
            loadMenu();
            showScreen('screen-menu');
        }

        function findMenuPrice(itemName) {
            const normalizedName = itemName.toLowerCase().trim();
            for (const menuItem of menuItems) {
                if (menuItem.name.toLowerCase().trim() === normalizedName) {
                    return menuItem.price;
                }
            }
            for (const menuItem of menuItems) {
                if (menuItem.name.toLowerCase().includes(normalizedName) || 
                    normalizedName.includes(menuItem.name.toLowerCase())) {
                    return menuItem.price;
                }
            }
            return null;
        }

        function goToPayment() {
            if (currentOrder.length === 0) {
                statusText.innerText = "Cart is empty!";
                statusText.classList.add("text-red-500");
                setTimeout(() => statusText.classList.remove("text-red-500"), 2000);
                return;
            }
            showScreen('screen-payment');
        }

        function goToQR(method) {
            document.getElementById('payment-method-label').innerText = `Paying via ${method}`;
            showScreen('screen-qr');
            qrTimer = setTimeout(() => {
                showScreen('screen-success');
            }, 3000);
        }

        function cancelPayment() {
            if (qrTimer) clearTimeout(qrTimer);
            showScreen('screen-pos');
        }

        function resetApp() {
            currentOrder = [];
            renderCart();
            statusText.innerText = "Tap mic to start listening...";
            showScreen('screen-pos');
        }

        // 3. RENDERING LOGIC (The "View")
        function renderCart() {
            cartContainer.innerHTML = '';
            
            if (currentOrder.length === 0) {
                cartContainer.appendChild(emptyState);
                emptyState.style.display = 'flex';
                totalPriceEl.innerText = '0';
                return;
            }

            emptyState.style.display = 'none';
            let total = 0;

            currentOrder.forEach((item, index) => {
                const itemTotal = (item.price || 0) * item.quantity;
                total += itemTotal;

                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex items-start gap-4 fade-in";
                
                const icon = guessIcon(item.item);
                
                let modifiersHtml = '';
                if (item.modifiers && item.modifiers.length > 0) {
                    modifiersHtml = `<div class="flex flex-wrap gap-1 mt-2">
                        ${item.modifiers.map(m => 
                            `<span class="px-2 py-1 bg-gray-100 text-gray-500 text-[10px] font-bold uppercase tracking-wide rounded-md">${m}</span>`
                        ).join('')}
                    </div>`;
                }

                card.innerHTML = `
                    <div class="w-12 h-12 rounded-xl bg-blue-50 text-blue-500 flex items-center justify-center text-2xl shrink-0">
                        ${icon}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg leading-tight truncate pr-2">${item.quantity}x ${item.item}</h3>
                            </div>
                            <span class="font-bold text-gray-900 whitespace-nowrap">${itemTotal.toLocaleString()}</span>
                        </div>
                        ${modifiersHtml}
                    </div>
                `;
                cartContainer.appendChild(card);
            });

            totalPriceEl.innerText = total.toLocaleString();
            cartContainer.scrollTop = cartContainer.scrollHeight;
        }

        function guessIcon(name) {
            const n = name.toLowerCase();
            if (n.includes('burger')) return 'ðŸ”';
            if (n.includes('rice')) return 'ðŸš';
            if (n.includes('noodle') || n.includes('pho') || n.includes('soup')) return 'ðŸœ';
            if (n.includes('coffee') || n.includes('tea') || n.includes('drink') || n.includes('coke')) return 'ðŸ¥¤';
            if (n.includes('fries')) return 'ðŸŸ';
            if (n.includes('ice cream')) return 'ðŸ¦';
            return 'ðŸ¥¡';
        }

        // 4. AUDIO LOGIC (The "Ear")
        async function toggleVoice() {
            if (!isRecording) {
                await startRecording();
            } else {
                await stopRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                    await sendToBackend(audioBlob);
                };

                mediaRecorder.start();
                isRecording = true;
                
                statusText.innerText = "Listening...";
                statusText.classList.add("text-red-500", "font-bold");
                micBtn.classList.add("mic-active");
                micIcon.classList.remove("ph-microphone");
                micIcon.classList.add("ph-waveform");

            } catch (err) {
                console.error(err);
                statusText.innerText = "Microphone access denied.";
            }
        }

        async function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                statusText.innerText = "Thinking...";
                statusText.classList.remove("text-red-500", "font-bold");
                statusText.classList.add("text-blue-600");
                micBtn.classList.remove("mic-active");
                micIcon.classList.add("ph-microphone");
                micIcon.classList.remove("ph-waveform");
            }
        }

        async function sendToBackend(blob) {
            const formData = new FormData();
            formData.append("file", blob);

            try {
                const response = await fetch('/process_audio', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error("Server Error");
                
                const data = await response.json();
                console.log("AI Response:", data);
                handleAIResponse(data);

            } catch (error) {
                console.error(error);
                statusText.innerText = "Connection Error. Try again.";
                statusText.classList.add("text-red-500");
            }
        }

        // ========================================================
        // 6. INTELLIGENCE HANDLER (The "Brain") - [FIXED]
        // ========================================================
        
        // Helper: ThÃªm mÃ³n vÃ o giá» (Cá»™ng dá»“n náº¿u trÃ¹ng)
        function addItemToCart(newItem) {
            // Logic láº¥y giÃ¡ (Price injection)
            if (!newItem.price || newItem.price === 0) {
                const menuPrice = findMenuPrice(newItem.item);
                if (menuPrice) newItem.price = menuPrice;
            }

            // Logic cá»™ng dá»“n
            const existingItem = currentOrder.find(i => i.item.toLowerCase() === newItem.item.toLowerCase());
            
            if (existingItem) {
                existingItem.quantity += (newItem.quantity || 1);
            } else {
                currentOrder.push(newItem);
            }
        }

        // Helper: XÃ³a mÃ³n khá»i giá» (Trá»« sá»‘ lÆ°á»£ng hoáº·c xÃ³a háº³n)
        function removeItemFromCart(itemToRemove) {
            // TÃ¬m mÃ³n trong giá»
            const index = currentOrder.findIndex(i => i.item.toLowerCase() === itemToRemove.item.toLowerCase());

            if (index !== -1) {
                const qtyToRemove = itemToRemove.quantity || 1;
                
                if (currentOrder[index].quantity > qtyToRemove) {
                    // Náº¿u sá»‘ lÆ°á»£ng trong giá» > sá»‘ muá»‘n xÃ³a -> Trá»« bá»›t
                    currentOrder[index].quantity -= qtyToRemove;
                } else {
                    // Náº¿u muá»‘n xÃ³a háº¿t -> XÃ³a háº³n
                    currentOrder.splice(index, 1);
                }
            }
        }

        function handleAIResponse(data) {
            // Reset status text
            setTimeout(() => {
                if(!isRecording) {
                    statusText.innerText = "Tap mic to start listening...";
                    statusText.className = "text-gray-500 font-medium mt-1";
                }
            }, 2500);

            // 1. HANDLE GLOBAL COMMANDS
            const command = data.global_command || data.command; // Backend gá»­i global_command
            
            if (command === "CHECKOUT") {
                goToPayment();
                return;
            }

            if (command === "CLEAR_CART") {
                currentOrder = [];
                renderCart();
                statusText.innerText = "Cart cleared.";
                return;
            }

            if (command === "SHOW_CART") {
                statusText.innerText = "Here is your order.";
                return;
            }

            // 2. HANDLE TRANSACTION RESULTS (ADD/REMOVE)
            if (data.results && data.results.length > 0) {
                let didChange = false;

                data.results.forEach(item => {
                    const action = item.action ? item.action.toLowerCase() : 'add';

                    if (action === 'remove') {
                        removeItemFromCart(item);
                        didChange = true;
                    } else {
                        // Máº·c Ä‘á»‹nh lÃ  add
                        addItemToCart(item);
                        didChange = true;
                    }
                });

                if (didChange) {
                    renderCart();
                    statusText.innerText = "Order updated.";
                }
            } else if (!command) {
                statusText.innerText = "I didn't catch that.";
            }
        }

        loadMenu();
    </script>
</body>
</html>